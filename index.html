<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koleksiyon Ar≈üivi</title>
    <link rel="icon" href="https://fav.farm/üìö">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9;
            --accent: #10b981; --figur-accent: #fbbf24;
            --edit: #3b82f6; --delete: #ef4444;
            --input: #334155; --switch-bg: #475569;
            --okunmus-renk: #fbbf24;
            --smooth-ease: cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .konteynir { width: 100%; max-width: 750px; }
        
        h1 { text-align: center; margin-bottom: 20px; font-size: 1.8rem; font-weight: 900; }
        .baslik-metni { background: linear-gradient(to right, #10b981, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .istatistik-bari { display: flex; gap: 10px; margin-bottom: 20px; }
        .istatistik-kart { flex: 1; background: var(--card); padding: 12px; border-radius: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.3s; }
        .istatistik-sayi { display: block; font-size: 1.1rem; font-weight: 900; }
        .istatistik-etiket { font-size: 0.65rem; opacity: 0.7; text-transform: uppercase; }

        .mod-secici { display: flex; background: var(--card); padding: 5px; border-radius: 15px; margin-bottom: 20px; gap: 5px; }
        .mod-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; background: transparent; }
        .mod-btn.aktif.kitap { background: var(--accent); color: #0f172a; }
        .mod-btn.aktif.figur { background: var(--figur-accent); color: #0f172a; }

        .giris-paneli { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.05); }
        .satir { display: flex; gap: 10px; margin-bottom: 10px; }
        input, textarea { background: var(--input); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; color: white; outline: none; width: 100%; font-family: inherit; }
        #anaButon { border: none; padding: 0 25px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }

        .seri-grubu { background: rgba(255, 255, 255, 0.03); border-radius: 15px; margin-bottom: 10px; border-left: 4px solid var(--accent); overflow: hidden; display: none; }
        .seri-grubu.figur-grubu { border-left-color: var(--figur-accent); }
        .seri-grubu.gorunur { display: block; }

        .seri-baslik { padding: 14px 18px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: bold; background: rgba(255,255,255,0.02); user-select: none; }
        .seri-sag-taraf { display: flex; align-items: center; gap: 10px; pointer-events: none; }
        .seri-sayac { font-size: 0.75rem; background: rgba(16, 185, 129, 0.1); padding: 3px 10px; border-radius: 20px; color: var(--accent); border: 1px solid var(--accent); font-weight: 600; }
        .figur-grubu .seri-sayac { color: var(--figur-accent); border-color: var(--figur-accent); background: rgba(251, 191, 36, 0.1); }
        .seri-ok { font-size: 0.6rem; transition: transform 0.3s; opacity: 0.5; }
        .acik .seri-ok { transform: rotate(180deg); }
        
        .seri-icerik { height: 0; overflow: hidden; opacity: 0; transition: height 0.4s var(--smooth-ease), opacity 0.3s; padding: 0 12px; }
        .seri-grubu.acik .seri-icerik { padding-bottom: 10px; opacity: 1; height: auto; }

        .kitap-satir { background: var(--card); padding: 10px 14px; border-radius: 10px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 8px; }
        .kitap-ust { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .kitap-adi { font-weight: 600; font-size: 0.9rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .okunmus .kitap-adi { opacity: 0.4; text-decoration: line-through; color: var(--okunmus-renk); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-icerik { background: var(--card); padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; display: flex; flex-direction: column; gap: 12px; border: 1px solid rgba(255,255,255,0.05); }
        
        .analiz-satir { display: flex; justify-content: space-between; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; font-size: 0.85rem; align-items: center; }
        .analiz-baslik { font-size: 0.7rem; text-transform: uppercase; color: var(--accent); margin-top: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; letter-spacing: 1px; }

        .modal-btn { background: var(--accent) !important; color: #0f172a !important; border: none; padding: 14px; border-radius: 12px; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        .modal-btn.figur-btn { background: var(--figur-accent) !important; }

        .islem-grubu { display: flex; align-items: center; gap: 8px; }
        .switch-konteynir { width: 40px; height: 22px; background: var(--switch-bg); border-radius: 50px; position: relative; cursor: pointer; }
        .switch-daire { width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s; }
        .switch-konteynir.aktif { background: var(--accent); }
        .switch-konteynir.aktif.f-aktif { background: var(--figur-accent); }
        .switch-konteynir.aktif .switch-daire { left: calc(100% - 19px); }

        #contextMenu { display: none; position: fixed; background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; z-index: 9999; min-width: 180px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); padding: 5px; }
        .context-item { padding: 12px 15px; cursor: pointer; font-size: 0.85rem; border-radius: 8px; }
        .context-item:hover { background: rgba(255,255,255,0.08); }

        .guncel-input { width: 80px !important; padding: 5px !important; text-align: center; border-color: var(--accent) !important; font-weight: bold; }
    </style>
</head>
<body onclick="ekranTikla(event)">

<div class="konteynir">
    <div class="istatistik-bari">
        <div class="istatistik-kart" onclick="detayGoster('kitap')">
            <span class="istatistik-sayi" id="sayacKitap" style="color:var(--accent)">0</span>
            <span class="istatistik-etiket">Kitap</span>
        </div>
        <div class="istatistik-kart" onclick="detayGoster('figur')">
            <span class="istatistik-sayi" id="sayacFigur" style="color:var(--figur-accent)">0</span>
            <span class="istatistik-etiket">Fig√ºr</span>
        </div>
        <div class="istatistik-kart" onclick="analizPanelAc()">
            <span class="istatistik-sayi" id="toplamPara" style="color:#3b82f6">0‚Ç∫</span>
            <span class="istatistik-etiket">Harcamalar üìä</span>
        </div>
    </div>

    <h1>üìö <span class="baslik-metni">KOLEKSƒ∞YON AR≈ûƒ∞Vƒ∞</span></h1>

    <div class="mod-secici">
        <button id="btnKitap" class="mod-btn aktif kitap" onclick="modDegistir('kitap')">üìö Kƒ∞TAPLAR</button>
        <button id="btnFigur" class="mod-btn figur" onclick="modDegistir('figur')">üß∏ Fƒ∞G√úRLER</button>
    </div>

    <div class="giris-paneli">
        <div class="satir">
            <input type="text" id="anaIsim" placeholder="Kitap/Cilt Adƒ±">
            <input type="text" id="seriAdi" placeholder="Seri Adƒ± (Klas√∂rlemek i√ßin)">
        </div>
        <div class="satir">
            <input type="number" step="0.01" id="fiyat" placeholder="Fiyat (‚Ç∫)">
            <button onclick="ogeEkle()" id="anaButon" style="background:var(--accent); color:#0f172a">Ekle</button>
        </div>
        <textarea id="not" placeholder="Notlar..."></textarea>
    </div>

    <div id="listeAlani"></div>
</div>

<div id="contextMenu">
    <div class="context-item" onclick="seriDuzenlePanel()">‚úèÔ∏è Klas√∂r Adƒ±nƒ± D√ºzenle</div>
    <div class="context-item" style="color:var(--delete)" onclick="seriSilOnay()">üóëÔ∏è Klas√∂r√º Sil</div>
</div>

<div id="genelModal" class="modal" onclick="modalDizginle(event)">
    <div class="modal-icerik" id="modalIcerik" onclick="event.stopPropagation()"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBsnqNr1GPKRZ8ktqbLq3eMqHu0Yq_gLyY",
        authDomain: "dijitalkitap-87eb7.firebaseapp.com",
        databaseURL: "https://dijitalkitap-87eb7-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "dijitalkitap-87eb7",
        storageBucket: "dijitalkitap-87eb7.firebasestorage.app",
        messagingSenderId: "926927401994",
        appId: "1:926927401994:web:58c88eec45965cc87fdbf3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let ogeler = [];
    let aktifMod = "kitap"; 
    let seciliSeriKey = null;

    db.ref('arsiv_data').on('value', (s) => {
        ogeler = s.val() || [];
        listele();
        istatistikGuncelle();
    });

    function veriyiKaydet() { db.ref('arsiv_data').set(ogeler); }

    function modDegistir(mod) {
        aktifMod = mod;
        document.getElementById('btnKitap').classList.toggle('aktif', mod === 'kitap');
        document.getElementById('btnFigur').classList.toggle('aktif', mod === 'figur');
        document.getElementById('anaButon').style.background = mod === 'figur' ? "var(--figur-accent)" : "var(--accent)";
        document.getElementById('anaIsim').placeholder = mod === 'figur' ? "Fig√ºr/Karakter Adƒ±" : "Kitap/Cilt Adƒ±";
        listele();
    }

    function ogeEkle() {
        const isim = document.getElementById('anaIsim').value.trim();
        const seri = document.getElementById('seriAdi').value.trim();
        const fiyat = parseFloat(document.getElementById('fiyat').value) || 0;
        const not = document.getElementById('not').value;
        if(!isim) return alert("ƒ∞sim giriniz!");
        ogeler.push({ id: Date.now(), isim, seri, fiyat, not, tur: aktifMod, okundu: false });
        veriyiKaydet();
        document.getElementById('anaIsim').value = ""; document.getElementById('seriAdi').value = ""; document.getElementById('fiyat').value = ""; document.getElementById('not').value = "";
    }

    function listele() {
        const liste = document.getElementById('listeAlani');
        const aciklar = Array.from(document.querySelectorAll('.seri-grubu.acik')).map(el => el.getAttribute('data-seri-key'));
        liste.innerHTML = "";
        const gruplar = {};
        const bagimsizOgeler = [];
        ogeler.forEach(o => {
            const tur = o.tur || 'kitap';
            if (tur !== aktifMod) return;
            if (o.seri && o.seri !== "") {
                const anahtar = o.seri + "_" + tur;
                if(!gruplar[anahtar]) gruplar[anahtar] = [];
                gruplar[anahtar].push(o);
            } else { bagimsizOgeler.push(o); }
        });
        for (let g in gruplar) {
            const tur = gruplar[g][0].tur || 'kitap';
            const seriAdi = gruplar[g][0].seri;
            const okunan = gruplar[g].filter(x => x.okundu).length;
            const div = document.createElement('div');
            div.className = `seri-grubu gorunur ${tur === 'figur' ? 'figur-grubu' : ''} ${aciklar.includes(g) ? 'acik' : ''}`;
            div.setAttribute('data-seri-key', g);
            div.oncontextmenu = (e) => menuAc(e, g);
            div.innerHTML = `<div class="seri-baslik" onclick="this.parentElement.classList.toggle('acik')"><span>${tur === 'kitap' ? 'üìÅ' : 'üì¶'} ${seriAdi}</span><div class="seri-sag-taraf"><span class="seri-sayac">${okunan} / ${gruplar[g].length}</span><span class="seri-ok">‚ñº</span></div></div><div class="seri-icerik">${gruplar[g].map(o => ogeSablonu(o)).join('')}</div>`;
            liste.appendChild(div);
        }
        if (bagimsizOgeler.length > 0) {
            const baslik = document.createElement('div');
            baslik.style.cssText = "font-size: 0.7rem; opacity: 0.5; margin: 15px 0 10px 5px; text-transform: uppercase; letter-spacing: 1px;";
            baslik.innerText = "Tekil Par√ßalar";
            liste.appendChild(baslik);
            bagimsizOgeler.forEach(o => {
                const div = document.createElement('div');
                div.innerHTML = ogeSablonu(o);
                liste.appendChild(div.firstChild);
            });
        }
    }

    function ogeSablonu(o) {
        return `<div class="kitap-satir ${o.okundu ? 'okunmus' : ''}" data-id="${o.id}"><div class="kitap-ust"><div class="kitap-adi" onclick="duzenlePanelAc(${o.id})">${o.isim}</div><div class="islem-grubu"><span style="font-size:0.7rem; opacity:0.6">${(o.fiyat || 0).toFixed(2)}‚Ç∫</span><div class="switch-konteynir ${o.okundu ? 'aktif' : ''} ${o.tur === 'figur' ? 'f-aktif' : ''}" onclick="durumDegistir(${o.id})"><div class="switch-daire"></div></div><span onclick="sil(${o.id})">üóëÔ∏è</span></div></div></div>`;
    }

    function analizPanelAc() {
        const kList = ogeler.filter(o => (o.tur || 'kitap') === 'kitap');
        const fList = ogeler.filter(o => o.tur === 'figur');
        const kH = kList.reduce((a, b) => a + (b.fiyat || 0), 0);
        const fH = fList.reduce((a, b) => a + (b.fiyat || 0), 0);
        
        const enPahaliK = kList.length ? kList.reduce((a, b) => a.fiyat > b.fiyat ? a : b) : null;
        const enPahaliF = fList.length ? fList.reduce((a, b) => a.fiyat > b.fiyat ? a : b) : null;
        const kListFiyatli = kList.filter(o => o.fiyat > 0);
        const fListFiyatli = fList.filter(o => o.fiyat > 0);
        const enUcuzK = kListFiyatli.length ? kListFiyatli.reduce((a, b) => a.fiyat < b.fiyat ? a : b) : null;
        const enUcuzF = fListFiyatli.length ? fListFiyatli.reduce((a, b) => a.fiyat < b.fiyat ? a : b) : null;

        const kaydedilmisGuncel = localStorage.getItem('guncel_taban_fiyat') || 0;

        modalAc(`
            <h2 style="margin:0; color:var(--accent); text-align:center;">üìä Finansal Analiz</h2>
            
            <div class="analiz-baslik">G√ºncel Deƒüer Hesaplayƒ±cƒ± (Kitap)</div>
            <div class="analiz-satir" style="background: rgba(16, 185, 129, 0.05); border: 1px dashed var(--accent);">
                <span>üìö Kitap Taban Fiyat:</span>
                <input type="number" id="guncelTabanFiyat" class="guncel-input" value="${kaydedilmisGuncel}" oninput="guncelDegerHesapla(this.value)">
            </div>
            <div class="analiz-satir" style="margin-top:5px; font-weight:bold; color:var(--accent)">
                <span>üìà G√ºncel Koleksiyon Deƒüeri:</span>
                <span id="guncelSonucDisplay">0.00‚Ç∫</span>
            </div>

            <div class="analiz-baslik">Harcanan Toplam</div>
            <div class="analiz-satir"><span>Kitaplar:</span> <b>${kH.toFixed(2)}‚Ç∫</b></div>
            <div class="analiz-satir"><span>Fig√ºrler:</span> <b>${fH.toFixed(2)}‚Ç∫</b></div>
            <div class="analiz-satir" style="border:1px solid var(--edit)"><span>Toplam:</span> <b>${(kH+fH).toFixed(2)}‚Ç∫</b></div>
            
            <div class="analiz-baslik">En Deƒüerliler</div>
            <div class="analiz-satir"><span>Pahalƒ± Kitap:</span> <span>${enPahaliK ? enPahaliK.isim : '-'} (${enPahaliK ? enPahaliK.fiyat : 0}‚Ç∫)</span></div>
            <div class="analiz-satir"><span>Ucuz Kitap:</span> <span>${enUcuzK ? enUcuzK.isim : '-'} (${enUcuzK ? enUcuzK.fiyat : 0}‚Ç∫)</span></div>
            
            <button class="modal-btn" style="margin-top:10px" onclick="modalKapat()">Kapat</button>
        `);
        
        // Modal a√ßƒ±ldƒ±ƒüƒ±nda hesaplamayƒ± bir kez √ßalƒ±≈ütƒ±r
        guncelDegerHesapla(kaydedilmisGuncel);
    }

    function guncelDegerHesapla(tabanFiyat) {
        const tf = parseFloat(tabanFiyat) || 0;
        localStorage.setItem('guncel_taban_fiyat', tf);
        
        const kList = ogeler.filter(o => (o.tur || 'kitap') === 'kitap');
        const fList = ogeler.filter(o => o.tur === 'figur');
        
        // Kitaplar i√ßin: Taban fiyattan d√º≈ü√ºkse taban fiyatƒ±, y√ºksekse kendi fiyatƒ±nƒ± al
        const guncelKitapToplam = kList.reduce((toplam, o) => {
            const kitapDegeri = (o.fiyat < tf) ? tf : (o.fiyat || 0);
            return toplam + kitapDegeri;
        }, 0);

        const figurToplam = fList.reduce((a, b) => a + (b.fiyat || 0), 0);
        const genelGuncelToplam = guncelKitapToplam + figurToplam;

        document.getElementById('guncelSonucDisplay').innerText = genelGuncelToplam.toFixed(2) + "‚Ç∫";
    }

    function detayGoster(tip) {
        const liste = ogeler.filter(o => (o.tur || 'kitap') === tip);
        const tamam = liste.filter(o => o.okundu).length;
        modalAc(`<h2 style="margin:0; color:${tip==='kitap'?'var(--accent)':'var(--figur-accent)'}; text-align:center;">${tip === 'kitap' ? 'üìò Kitap' : '‚ú® Fig√ºr'} √ñzeti</h2><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;"><div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; text-align:center;"><small>Tamamlanan</small><br><b style="font-size:1.2rem; color:${tip==='kitap'?'var(--accent)':'var(--figur-accent)'}">${tamam}</b></div><div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; text-align:center;"><small>Bekleyen</small><br><b style="font-size:1.2rem; color:var(--edit)">${liste.length - tamam}</b></div></div><button class="modal-btn ${tip==='figur'?'figur-btn':''}" onclick="modalKapat()">Kapat</button>`);
    }

    function modalDizginle(e) { if (e.target.id === "genelModal") modalKapat(); }
    function ekranTikla(e) { document.getElementById('contextMenu').style.display = 'none'; }
    function modalAc(html) { document.getElementById('modalIcerik').innerHTML = html; document.getElementById('genelModal').style.display = 'flex'; }
    function modalKapat() { document.getElementById('genelModal').style.display = 'none'; }
    function durumDegistir(id) { ogeler = ogeler.map(o => o.id === id ? {...o, okundu: !o.okundu} : o); veriyiKaydet(); }
    function sil(id) { if(confirm("Sil?")) { ogeler = ogeler.filter(o => o.id !== id); veriyiKaydet(); } }
    function istatistikGuncelle() {
        document.getElementById('sayacKitap').innerText = ogeler.filter(o => (o.tur || 'kitap') === 'kitap').length;
        document.getElementById('sayacFigur').innerText = ogeler.filter(o => o.tur === 'figur').length;
        document.getElementById('toplamPara').innerText = ogeler.reduce((a, b) => a + (b.fiyat || 0), 0).toFixed(2) + "‚Ç∫";
    }
    function menuAc(e, k) { e.preventDefault(); seciliSeriKey = k; const m = document.getElementById('contextMenu'); m.style.display = 'block'; let x = e.clientX, y = e.clientY; if (x + 180 > window.innerWidth) x -= 180; if (y + 100 > window.innerHeight) y -= 100; m.style.left = x + 'px'; m.style.top = y + 'px'; e.stopPropagation(); }
    function seriDuzenlePanel() { const seri = ogeler.find(o => (o.seri+"_"+(o.tur||'kitap'))===seciliSeriKey).seri; const yeni = prompt("Klas√∂r Adƒ±:", seri); if(yeni) { ogeler = ogeler.map(o => (o.seri+"_"+(o.tur||'kitap'))===seciliSeriKey ? {...o, seri:yeni} : o); veriyiKaydet(); } }
    function seriSilOnay() { if(confirm("Klas√∂r√º sil?")) { ogeler = ogeler.filter(o => (o.seri+"_"+(o.tur||'kitap'))!==seciliSeriKey); veriyiKaydet(); } }
    function duzenlePanelAc(id) { const o = ogeler.find(x => x.id === id); modalAc(`<h3>‚úèÔ∏è D√ºzenle</h3><input type="text" id="mAd" value="${o.isim}"><input type="text" id="mSeri" value="${o.seri||''}" placeholder="Klas√∂r Adƒ±"><input type="number" step="0.01" id="mFiyat" value="${o.fiyat}"><textarea id="mNot">${o.not||''}</textarea><button class="modal-btn ${o.tur==='figur'?'figur-btn':''}" onclick="kaydetDuzenleme(${id})">Kaydet</button>`); }
    function kaydetDuzenleme(id) { ogeler = ogeler.map(o => o.id === id ? {...o, isim:document.getElementById('mAd').value, seri:document.getElementById('mSeri').value, fiyat:parseFloat(document.getElementById('mFiyat').value)||0, not:document.getElementById('mNot').value} : o); veriyiKaydet(); modalKapat(); }
</script>
</body>
</html>